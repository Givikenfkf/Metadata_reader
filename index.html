<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Metadata Compare — optimized</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#071827;--panel:#0b1220;--muted:#9aa6bf;--accent:#7dd3fc}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071325,#071827);color:#e6eef8}
  .wrap{max-width:1000px;margin:20px auto;padding:16px;border-radius:12px;background:rgba(255,255,255,0.02)}
  header{display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .panel{background:var(--panel);padding:12px;border-radius:10px;margin-top:12px}
  label.file{display:inline-flex;gap:8px;align-items:center}
  input, textarea, button{font:inherit}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;color:var(--muted)}
  textarea{width:100%;height:320px;background:transparent;color:inherit;border:1px dashed rgba(255,255,255,0.04);padding:10px;border-radius:8px;font-family:monospace;resize:vertical}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(180deg,var(--accent),#60a5fa);color:#042233;font-weight:600;cursor:pointer}
  .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .note{margin-top:8px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Metadata Compare — optimized</h1>
        <div class="muted">Load two metadata files (original & modified). Output lists only Changed / Added / Removed strings.</div>
      </div>
    </header>

    <div class="panel">
      <div class="row" style="margin-bottom:10px">
        <label class="file small">Original (unmodified):
          <input id="fileOrig" type="file" accept="*"/>
        </label>

        <label class="file small">Modified:
          <input id="fileMod" type="file" accept="*"/>
        </label>

        <div style="margin-left:auto" class="small">Min string length:
          <input id="minLen" type="number" value="24" style="width:72px;margin-left:6px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" />
        </div>
      </div>

      <div class="controls">
        <button id="btnCompare" class="btn">Compare</button>
        <button id="btnClear" class="btn alt">Clear</button>
        <button id="btnDownload" class="btn alt">Download changed.txt</button>
        <div style="margin-left:auto" class="small muted" id="status">No files loaded</div>
      </div>

      <div class="note">Output: only changed strings. For large files, the page remains responsive.</div>

      <div style="margin-top:12px">
        <textarea id="out" placeholder="Output will appear here — only changed strings..." readonly></textarea>
      </div>
    </div>
  </div>

<script>
/* ------------------- Helpers ------------------- */
function isPrintable(b){ return b >= 32 && b <= 126; }
function decodeAscii(bytes){ return new TextDecoder('latin1').decode(bytes); }
function decodeUtf16le(bytes){ 
  if(bytes.length<2) return ''; 
  try { return new TextDecoder('utf-16le').decode(bytes); } 
  catch(e){ 
    let s=''; for(let i=0;i+1<bytes.length;i+=2) s+=String.fromCharCode(bytes[i]|(bytes[i+1]<<8)); 
    return s; 
  }
}
function normalizeStr(s){ return s.replace(/\u0000/g,'').replace(/\r/g,'').replace(/\t/g,' ').replace(/\s+/g,' ').trim(); }

/* ------------------- Extraction ------------------- */
function extractAsciiRuns(u8,minLen){
  const runs=[]; let i=0;
  while(i<u8.length){
    if(isPrintable(u8[i])){
      const start=i; while(i<u8.length && isPrintable(u8[i])) i++;
      if(i-start>=minLen) runs.push({offset:start,length:i-start,encoding:'ASCII',text:normalizeStr(decodeAscii(u8.slice(start,i)))});
    } else i++;
  }
  return runs;
}

function extractUtf16leRuns(u8,minChars){
  const runs=[]; let i=0;
  while(i+1<u8.length){
    if(isPrintable(u8[i]) && u8[i+1]===0){
      const start=i; let chars=0;
      while(i+1<u8.length && isPrintable(u8[i]) && u8[i+1]===0){ chars++; i+=2; }
      if(chars>=minChars){ runs.push({offset:start,length:chars*2,encoding:'UTF-16LE',text:normalizeStr(decodeUtf16le(u8.slice(start,start+chars*2)))}) }
    } else i++;
  }
  return runs;
}

function uniqueByOffset(list){
  list.sort((a,b)=>a.offset-b.offset || b.length-b.length);
  const out=[]; const seen=new Set();
  for(const it of list){ if(!seen.has(it.offset)){ out.push(it); seen.add(it.offset); } }
  return out;
}

/* ------------------- Fast similarity ------------------- */
function quickSim(a,b){
  if(a===b) return 1;
  if(a.includes(b) || b.includes(a)) return 0.9;
  if(Math.abs(a.length-b.length)>10) return 0;
  return 0.5;
}

/* ------------------- UI ------------------- */
const fileOrig = document.getElementById('fileOrig');
const fileMod  = document.getElementById('fileMod');
const btnCompare = document.getElementById('btnCompare');
const btnClear = document.getElementById('btnClear');
const out = document.getElementById('out');
const status = document.getElementById('status');
const btnDownload = document.getElementById('btnDownload');

let origBuf=null, modBuf=null, lastResultText='';

function readFileInput(fileInput, cb){
  const f=fileInput.files && fileInput.files[0];
  if(!f){ cb(null); return; }
  f.arrayBuffer().then(ab=>cb(new Uint8Array(ab))).catch(e=>{ console.error(e); cb(null); });
}

function loadBothBuffersThen(action){
  readFileInput(fileOrig,a=>{ origBuf=a; readFileInput(fileMod,b=>{ modBuf=b; action(); }); });
}

btnCompare.addEventListener('click',()=>loadBothBuffersThen(runCompare));
btnClear.addEventListener('click',()=>{ out.value=''; lastResultText=''; fileOrig.value=''; fileMod.value=''; origBuf=null; modBuf=null; status.textContent='Cleared'; });
btnDownload.addEventListener('click',()=>{
  if(!lastResultText){ alert('No output to download'); return; }
  const blob = new Blob([lastResultText], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='changed_strings.txt';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ------------------- Main compare ------------------- */
function runCompare(){
  out.value=''; lastResultText='';
  if(!origBuf || !modBuf){ status.textContent='Load both files'; return; }
  const minLen = Math.max(4, parseInt(document.getElementById('minLen').value||'24',10));
  const minUtf = Math.floor(minLen/2);
  status.textContent='Extracting printable runs...';

  let origSegments = uniqueByOffset(extractAsciiRuns(origBuf,minLen).concat(extractUtf16leRuns(origBuf,minUtf)));
  let modSegments  = uniqueByOffset(extractAsciiRuns(modBuf,minLen).concat(extractUtf16leRuns(modBuf,minUtf)));
  status.textContent = `Found ${origSegments.length} orig runs, ${modSegments.length} mod runs — matching...`;

  const WINDOW = 64, SIM_THRESH = 0.5;
  const modM
